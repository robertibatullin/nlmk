
# Работа с пакетом ```nlmk```

## Установка под ```anaconda```

* Войти в командную строку Conda Prompt (Windows) или открыть терминал (Linux)


* Создать и активировать новое окружение conda:

```bash
conda create -n nlmk
conda activate nlmk
```

* Установить пакет ```nlmk```:

```bash
pip install git+https://github.com/robertibatullin/nlmk
```

* Скачать обученную нейросеть (файлы ```day.pth```, ```night.pth```) с указанного адреса и поместить оба файла в одну папку (любую).


* Установить конвертер видеофайлов ```ffmpeg``` (https://www.ffmpeg.org)

## Работа с программой ```make_clips```

### Запуск

Перед работой с программой нужно активировать окружение ```conda nlmk```:

```bash
conda activate nlmk
```

А после окончания работы деактивировать:

```bash
conda deactivate
```

Программа ```make_clips``` детектирует на видео фракцию гравия и (при включенном режиме ```write```) записывает клипы, показывающие работу детектора.

Запуск из командной строки:

```bash
make_clips --daytime <ВРЕМЯ СУТОК (day/night), ПО УМОЛЧАНИЮ day>
           --model_folder <ПАПКА С ФАЙЛАМИ day.pth, night.pth>
           --video_folder <ПАПКА С ВИДЕОФАЙЛАМИ ДЛЯ АНАЛИЗА>
           --video_file_index <НОМЕР ВИДЕОФАЙЛА В ПАПКЕ, ПО УМОЛЧАНИЮ 0>
           --output_folder <ПАПКА, КУДА ЗАПИСЫВАТЬ КЛИПЫ>
           --write <РЕЖИМ ОЗНАКОМЛЕНИЯ (0) ИЛИ РЕЖИМ ЗАПИСИ КЛИПА (1), ПО УМОЛЧАНИЮ 0>
           --start <С КАКОЙ СЕКУНДЫ НАЧИНАТЬ АНАЛИЗ В РЕЖИМЕ ЗАПИСИ, ПО УМОЛЧАНИЮ 0>
```
### Управление

После запуска программы начнётся показ выбранного видеофайла. Появится белая рамка с надписью "Detection OFF" и таймером. С помощью клавиш стрелок нужно навести эту рамку на область чуть выше верхней кромки ковша погрузчика. Чтобы включить детектирование, нажмите пробел. Рамка станет цветной, и в ней появится обозначение детектированной фракции. Чтобы отключить детектирование, снова нажмите пробел. Чтобы выйти, нажмите Esc.

Сначала запустите программу в режиме ознакомления (```--write 0```). Видео будет прокручиваться ускоренно. Найдите, с какой секунды ковш загружается, так чтобы была видна загруженная в него куча гравия.

С этой секунды (задав её в параметре ```--start```, например ```--start 30```) запустите программу в режиме записи (```--write 1```). Видео будет прокручиваться замедленно, что позволит вам точно навести рамку на нужную область. Когда ковш разгрузится или гравия в нём не будет видно, выйдите из программы, нажав Esc.
